apiVersion: apps/v1
kind: Deployment
metadata:
  name: librechat-api
  namespace: {{ .Release.Namespace }}
  labels:
    app: librechat-api
    {{- include "accessllm.labels" . | nindent 4 }}
spec:
  replicas: {{ .Values.replicaCount }}
  selector:
    matchLabels:
      app: librechat-api
  template:
    metadata:
      annotations:
        checksum/config: {{ include (print .Template.BasePath "/librechat-yaml-configmap.yaml") . | sha256sum }}
        checksum/env: {{ include (print .Template.BasePath "/configmap.yaml") . | sha256sum }}
        checksum/secrets: {{ include (print .Template.BasePath "/secrets.yaml") . | sha256sum }}
      labels:
        app: librechat-api
    spec:
      initContainers:
      - name: fix-permissions
        image: busybox
        command: ["sh", "-c", "chown -R 1000:1000 /data"]
        volumeMounts:
        - name: data-volume
          mountPath: /data
      - name: wait-for-litellm
        image: curlimages/curl:8.9.1
        command:
        - sh
        - -c
        - |
          echo "Waiting for LiteLLM at http://litellm:8000/v1/models ..."
          until curl -sf -H "Authorization: Bearer $(LITELLM_MASTER_KEY)" http://litellm:8000/v1/models >/dev/null 2>&1; do
            echo "LiteLLM not ready, waiting..."
            sleep 2
          done
          echo "LiteLLM is ready."
        env:
        - name: LITELLM_MASTER_KEY
          valueFrom:
            secretKeyRef:
              name: librechat-secrets
              key: LITELLM_MASTER_KEY
      containers:
      - name: api
        image: "{{ .Values.image.repository }}:{{ .Values.image.tag | default .Chart.AppVersion }}"
        imagePullPolicy: {{ .Values.image.pullPolicy }}
        command: ["node", "api/server/index.js"]
        ports:
        - containerPort: 3080
        envFrom:
        - configMapRef:
            name: librechat-config
        - secretRef:
            name: librechat-secrets
        env:
        - name: MONGO_URI
          value: "mongodb://$(MONGO_ROOT_USER):$(MONGO_ROOT_PASS)@mongodb:27017/LibreChat?authSource=admin"
        - name: DATABASE_URL
          value: "postgresql://$(POSTGRES_USER):$(POSTGRES_PASSWORD)@vectordb:5432/$(POSTGRES_DB)"
        volumeMounts:
        - name: data-volume
          mountPath: /app/uploads
          subPath: uploads
        - name: data-volume
          mountPath: /app/api/logs
          subPath: logs
        - name: data-volume
          mountPath: /app/client/public/images
          subPath: images
        - name: librechat-config-file
          mountPath: /app/librechat.yaml
          subPath: librechat.yaml
        resources:
          {{- toYaml .Values.resources | nindent 10 }}
        livenessProbe:
          httpGet:
            path: /
            port: 3080
          initialDelaySeconds: 60
          periodSeconds: 10
        readinessProbe:
          httpGet:
            path: /
            port: 3080
          initialDelaySeconds: 30
          periodSeconds: 5
      volumes:
      - name: data-volume
        persistentVolumeClaim:
          claimName: librechat-uploads
      - name: librechat-config-file
        configMap:
          name: librechat-yaml-config
