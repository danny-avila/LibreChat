{{- if .Values.litellm.enabled -}}
apiVersion: v1
kind: ConfigMap
metadata:
  name: litellm-config
  namespace: {{ .Release.Namespace }}
  labels:
    app: litellm
    {{- include "accessllm.labels" . | nindent 4 }}
data:
  config.yaml: |
    # LiteLLM configuration
    model_list: []
  watch_models.sh: |
    #!/bin/sh
    set -eu
    # Catch pipeline failures (like curl failing) so we don't hash empty strings
    set -o pipefail

    AUTH_HEADER="Authorization: Bearer ${LITELLM_MASTER_KEY:-}"
    LITELLM_MODELS_URL="${LITELLM_MODELS_URL:-http://localhost:8000/v1/models}"
    CHECK_EVERY="${CHECK_EVERY:-15}"
    NAMESPACE="${NAMESPACE:-librechat}"
    DEPLOYMENT="${DEPLOYMENT:-librechat-api}"

    # Install dependencies
    apk add --no-cache curl kubectl jq

    hash_models() {
      # Use jq to sort keys (-S) to ensure deterministic JSON output
      curl -sf -H "$AUTH_HEADER" "$LITELLM_MODELS_URL" | jq -S . | sha256sum | awk '{print $1}'
    }

    restart_deployment() {
      echo "üîÑ Restarting deployment $DEPLOYMENT in namespace $NAMESPACE..."
      kubectl rollout restart deployment/"$DEPLOYMENT" -n "$NAMESPACE"
    }

    echo "‚è≥ Waiting for LiteLLM models endpoint at $LITELLM_MODELS_URL..."
    until current="$(hash_models)"; do
      echo "Waiting for LiteLLM..."
      sleep 5
    done
    last="$current"
    echo "‚úÖ Initial models hash: $last"
    echo "üëÄ Watching for changes every $CHECK_EVERY seconds..."

    while true; do
      sleep "$CHECK_EVERY"
      if current="$(hash_models)"; then
        if [ "$current" != "$last" ]; then
          echo "üö® Models changed ($last -> $current). Triggering restart..."
          restart_deployment || echo "‚ùå Restart failed."
          last="$current"
        fi
      else
        echo "‚ö†Ô∏è Could not reach models endpoint; will retry."
      fi
    done
{{- end }}
