FROM node:20-alpine

# Install jemalloc
RUN apk add --no-cache jemalloc
RUN apk add --no-cache python3 py3-pip uv
# Added: su-exec for privilege drop
RUN apk add --no-cache su-exec
# Added build deps for sharp
RUN apk add --no-cache build-base vips-dev

# Set environment variable to use jemalloc
ENV LD_PRELOAD=/usr/lib/libjemalloc.so.2

# Add `uv` for extended MCP support
COPY --from=ghcr.io/astral-sh/uv:0.6.13 /uv /uvx /bin/

# Install nodemon for hot-reloading
RUN npm install -g nodemon

RUN mkdir -p /app && chown node:node /app
WORKDIR /app

# Replace full copy with manifest-only for layer cache
# (Source is bind-mounted at runtime)
COPY --chown=root:root ../package.json ../package-lock.json* ./ || true

RUN \
    npm config set fetch-retry-maxtimeout 600000 ; \
    npm config set fetch-retries 5 ; \
    npm config set fetch-retry-mintimeout 15000 ; \
    if [ -f package-lock.json ]; then npm ci --include=optional; else npm install --include=optional || true; fi

EXPOSE 3080 3090 3000
ENV HOST=0.0.0.0

