# E2B Data Analyst Agent 测试用例

## 测试环境准备
- 测试数据集：`titanic.csv`（Kaggle Titanic数据集）
- 测试用户：已登录的LibreChat用户
- 测试端点：E2B Assistants

---

## 测试场景 1: 基础数据分析与可视化

### 第1轮 - 初始化对话并上传文件
**操作**: 上传 `titanic.csv` 文件
**Prompt**:
```
请对这个数据集进行探索性数据分析，生成以下内容：
1. 数据集的基本信息（行数、列数、字段）
2. 前5行数据预览
3. 缺失值统计
4. 生成2-3个可视化图表
```

**预期输出格式** (参照Azure Assistant):
```
好的！我将对数据集进行以下探索性分析：
1. 数据集基本信息（行数、列数、字段）
2. 前5行数据预览
3. 缺失值统计
4. 生成2-3个可视化图表

下面我们先读取数据并获取基本信息：

[显示Python代码]
import pandas as pd
df = pd.read_csv('/home/user/titanic.csv')
...

[执行代码后输出结果]
数据集基本信息：
- 行数: 891
- 列数: 12
- 字段: PassengerId, Survived, ...

前5行数据预览：
[表格数据]

接下来分析缺失值：

[显示Python代码]
missing = df.isnull().sum()
...

[执行代码后输出结果]
缺失值统计：
- Age: 177个缺失值
- Cabin: 687个缺失值

现在生成可视化图表：

[显示绘图代码]
import matplotlib.pyplot as plt
...

[图片显示]
![生存率分布](图片路径)

图表说明：...
```

**预期结果**:
- ✅ **先输出计划**: 列出要完成的4个分析任务
- ✅ **分步骤输出**: 完成基本信息后立即显示，不等待后续步骤
- ✅ **显示代码**: 每个分析步骤都显示将要执行的Python代码
- ✅ **渐进式结果**: 基本信息 → 预览 → 缺失值 → 图表，依次输出
- ✅ 显示数据集基本信息
- ✅ 显示前5行数据（格式化表格）
- ✅ 显示缺失值统计
- ✅ 生成2-3个图表并正确显示
- ✅ 每个图表都有说明文字
- ✅ 图片路径格式正确（`/images/userId/timestamp-plot-X.png`）
- ✅ **流式输出逐步显示**（不是等所有任务完成后才显示）

---

### 第2轮 - 测试文件记忆功能
**Prompt**:
```
再生成两个饼状图：一个显示性别分布，另一个显示生存情况分布
```

**预期结果**:
- ✅ Agent记得titanic.csv文件仍然可用
- ✅ 不要求重新上传文件
- ✅ 成功生成两个饼状图
- ✅ 图片正确显示
- ✅ 图片路径替换正确

---

### 第3轮 - 测试连续对话上下文
**Prompt**:
```
基于刚才的分析，计算各个舱位等级（Pclass）的平均生存率
```

**预期结果**:
- ✅ Agent记得之前的分析结果
- ✅ Agent记得数据集仍然存在
- ✅ 正确计算各舱位等级的生存率
- ✅ 可能生成条形图展示结果

---

### 第4轮 - 测试图表引用功能
**Prompt**:
```
总结一下你刚才生成的所有图表，说明每个图表展示了什么信息
```

**预期结果**:
- ✅ Agent记得之前生成的所有图表
- ✅ 能够描述每个图表的内容
- ✅ 可能重新显示之前的图表（如果LLM引用了路径）

---

### 第5轮 - 测试长对话稳定性
**Prompt**:
```
现在分析年龄与生存率的关系，将年龄分为几个区间（如0-18, 18-35, 35-60, 60+），计算每个区间的生存率并绘制图表
```

**预期结果**:
- ✅ 在多轮对话后仍然稳定运行
- ✅ 文件仍然可用
- ✅ 正确执行复杂的数据分析逻辑
- ✅ 生成图表

---

## 测试场景 2: 代码执行与错误处理

### 第1轮 - 正常代码执行
**操作**: 上传 `titanic.csv`
**Prompt**:
```
使用pandas读取数据，然后计算：
1. 男性和女性乘客的平均年龄
2. 不同舱位的平均票价
3. 生存者和遇难者的平均年龄差异
```

**预期结果**:
- ✅ 正确执行pandas代码
- ✅ 返回准确的统计结果
- ✅ 格式化输出清晰

---

### 第2轮 - 复杂可视化
**Prompt**:
```
创建一个2x2的子图布局，分别显示：
1. 年龄分布直方图
2. 票价分布箱线图
3. 生存率按性别的条形图
4. 舱位分布的饼图
```

**预期结果**:
- ✅ 正确创建多子图布局
- ✅ 所有4个子图都正确生成
- ✅ 图片保存和路径替换正确
- ✅ 图片在前端正确显示

---

### 第3轮 - 测试数据持久性
**Prompt**:
```
基于之前分析的数据，创建一个新的特征"家庭人数"（SibSp + Parch），然后分析家庭人数与生存率的关系
```

**预期结果**:
- ✅ 能够在之前的数据基础上继续分析
- ✅ DataFrame变量在多次代码执行间保持
- ✅ 正确创建新特征并分析

---

## 测试场景 3: 流式输出测试

### 第1轮 - 长文本生成
**操作**: 上传 `titanic.csv`
**Prompt**:
```
请详细分析Titanic数据集，包括：
1. 每个字段的详细统计信息
2. 各个变量之间的相关性分析
3. 生存率的多维度分析（性别、年龄、舱位、登船港口等）
4. 生成5个以上的可视化图表
5. 给出最终的分析结论和发现
```

**预期结果**:
- ✅ 文本分段流式显示(思考阶段)
- ✅ 显示工具执行提示："[执行工具: execute_code]"
- ✅ 工具执行后继续流式输出结果
- ✅ 所有图表正确生成和显示
- ✅ 最终文本完整

**已知行为**:
- ⚠️ 复杂分析最大支持20次迭代
- ✅ 系统会在第17次迭代时提醒 LLM 提供总结
- ✅ LLM 应在接近限制时提供结论而非继续执行代码
- ℹ️ 大多数分析应在10次迭代内完成

**错误处理策略**:
- ✅ **关键错误**(如文件路径、模块导入)会提供具体指导
- ✅ **其他错误**会提供通用调试思路,让LLM自行分析traceback解决
- ✅ 避免为每种特定错误硬编码解决方案,保持系统灵活性

**常见错误示例**(LLM会自动处理):
- ❌ `ValueError: could not convert string to float`
  - LLM应检查数据类型,使用 `df.dtypes` 分析,选择正确的列
- ❌ `KeyError: 'column_name'`
  - LLM应检查可用列名,使用 `df.columns.tolist()`
- ❌ `TypeError: unsupported operand type(s)`  
  - LLM应检查操作的数据类型是否匹配

**系统会提供特定指导的错误**:
- ❌ `FileNotFoundError` → 显示可用文件路径
- ❌ `'seaborn' is not a valid package style` → 提供替代样式
- ❌ `ModuleNotFoundError` → 提示检查允许的库列表

---

### 第2轮 - 测试流式连续性
**Prompt**:
```
继续深入分析，探索一些更有趣的模式，例如：
- 名字中的称谓（如Mr, Mrs, Miss）与生存率的关系
- 票号的前缀与舱位的关系
- 不同港口登船乘客的特征差异
```

**预期结果**:
- ✅ 流式输出保持连续
- ✅ 每个分析点逐步展示
- ✅ 代码执行时显示进度

---


## 测试场景 4: 复杂统计分析

### 第1轮 - 高级统计
**操作**: 上传 `titanic.csv`
**Prompt**:
```
执行以下高级统计分析：
1. 卡方检验：测试性别与生存率的独立性
2. T检验：比较生存者和遇难者的平均年龄
3. 方差分析：比较不同舱位的平均票价
4. 相关性矩阵：计算数值型变量之间的相关系数
5. 生成相关性热力图
```

**预期结果**:
- ✅ 正确执行所有统计测试
- ✅ 返回统计显著性结果
- ✅ 热力图正确生成和显示

---

### 第2轮 - 机器学习预测
**Prompt**:
```
使用简单的逻辑回归模型预测生存率，特征包括：性别、年龄、舱位、票价。显示模型准确率和混淆矩阵。
```

**预期结果**:
- ✅ 能够使用scikit-learn（如果允许）
- ✅ 正确训练模型
- ✅ 显示评估指标
- ✅ 生成混淆矩阵可视化

---

## 测试场景 5: 性能与限制测试

### 第1轮 - 大量数据处理
**操作**: 上传 `titanic.csv`
**Prompt**:
```
生成10个不同的可视化图表，展示数据集的各个方面
```

**预期结果**:
- ✅ 能够处理多个图表生成
- ✅ 所有图表路径正确替换
- ✅ 不超时

---

### 第2轮 - 复杂计算
**Prompt**:
```
对数据集进行1000次bootstrap重采样，计算生存率的95%置信区间
```

**预期结果**:
- ✅ 能够执行耗时计算
- ✅ 在超时限制内完成
- ✅ 返回正确结果

---

## 测试场景 6: 集成功能测试

### 完整工作流测试
**第1轮**: 上传 `titanic.csv`
```
分析这个数据集并生成报告
```

**第2轮**:
```
基于你的分析，生成3个最重要的可视化图表
```

**第3轮**:
```
这些图表告诉我们什么？有什么有趣的发现？
```

**第4轮**:
```
如果我想提高生存率预测的准确性，应该重点关注哪些特征？
```

**第5轮**:
```
生成一个综合的仪表板图片，包含所有关键指标
```

**第6轮**:
```
总结整个分析过程和主要结论
```

**预期结果**:
- ✅ 整个流程顺畅
- ✅ 文件在所有轮次都可用
- ✅ 所有图表正确显示
- ✅ 上下文保持连贯
- ✅ 最终总结包含之前的所有发现

---

## 检查清单

### 功能正确性
- [ ] 文件上传和读取
- [ ] 代码执行
- [ ] 图表生成
- [ ] 图片路径替换
- [ ] 图片显示

### 多轮对话
- [ ] 文件记忆（2轮后仍记得）
- [ ] 文件记忆（5轮后仍记得）
- [ ] 上下文连贯性
- [ ] 历史对话引用

### 流式输出
- [ ] 文本逐步显示
- [ ] 工具执行提示显示
- [ ] 不同语言token流式正常

### 错误处理
- [ ] 语法错误捕获
- [ ] 运行时错误捕获
- [ ] 错误后能恢复
- [ ] 友好错误信息

### 性能
- [ ] 响应速度合理
- [ ] 不超时
- [ ] 多图表处理正常
- [ ] 长对话不降级

### 边界情况
- [ ] 无文件时提示正确
- [ ] 空对话处理正常
- [ ] 重复请求处理正常
- [ ] 长对话稳定性

---

## 测试报告模板

```markdown
## 测试日期: YYYY-MM-DD
## 测试人员: [姓名]
## 版本: [版本号]

### 场景1: 基础数据分析
- 第1轮: ✅/❌ [备注]
- 第2轮: ✅/❌ [备注]
- 第3轮: ✅/❌ [备注]
- 第4轮: ✅/❌ [备注]
- 第5轮: ✅/❌ [备注]

### 场景2: 代码执行
- 第1轮: ✅/❌ [备注]
- 第2轮: ✅/❌ [备注]
- 第3轮: ✅/❌ [备注]

### 发现的问题
1. [问题描述]
   - 重现步骤: 
   - 预期结果:
   - 实际结果:
   - 严重程度: 高/中/低

### 改进建议
1. [建议内容]

### 总体评分
- 功能完整性: __/10
- 稳定性: __/10
- 用户体验: __/10
- 性能: __/10