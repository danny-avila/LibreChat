# E2B Data Analyst Agent å¼€å‘æ–‡æ¡£

## 1. é¡¹ç›®æ¦‚è¿°

### 1.1 ç›®æ ‡
åœ¨LibreChaté¡¹ç›®ä¸­å¼€å‘åŸºäºE2Bæ²™ç®±çš„æ•°æ®åˆ†æAgentæ¨¡å—ï¼Œä¸Azure Assistants**å¹¶è¡Œ**è¿è¡Œï¼Œç”¨äºå¤„ç†Azure Assistantsæ— æ³•è§£å†³çš„åœºæ™¯ï¼ˆå¦‚é•¿æ—¶é—´è¿è¡Œçš„ä»£ç æ‰§è¡Œã€XGBoostç­‰å¯†é›†å‹å·¥ä½œè´Ÿè½½ï¼‰ã€‚

### 1.2 æ¶æ„å®šä½
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    LibreChat Frontend                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  API Layer (Express.js)                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚  â”‚ Azure Assistants â”‚  â”‚  E2B Assistants  â”‚              â”‚
â”‚  â”‚  (ç°æœ‰)          â”‚  â”‚  (æ–°å¢)          â”‚              â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â”‚         â”‚                        â”‚                       â”‚
â”‚         â–¼                        â–¼                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚  â”‚ Azure OpenAI API â”‚  â”‚  E2B + LLM API   â”‚              â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**é‡è¦è¯´æ˜**ï¼š
- **ä¸åˆ é™¤**ç°æœ‰çš„Azure Assistantsæ¨¡å—
- ä¸¤è€…å¹¶è¡Œè¿è¡Œï¼Œæ ¹æ®ä½¿ç”¨åœºæ™¯é€‰æ‹©
- E2B Agentä¸“é—¨ç”¨äºéœ€è¦é•¿æ—¶é—´ä»£ç æ‰§è¡Œã€å¤æ‚è®¡ç®—çš„åœºæ™¯
- è®¿é—®æ§åˆ¶ï¼ˆç§æœ‰/å…¬å…±Assistantï¼‰ç”±åä½œäººå‘˜å®ç°

---

## 2. èŒè´£åˆ†å·¥

| æ¨¡å— | è´Ÿè´£äºº | è¯´æ˜ |
|------|--------|------|
| E2Bå®¢æˆ·ç«¯é›†æˆ | **å½“å‰å¼€å‘** | E2B SDKé›†æˆã€æ²™ç®±ç®¡ç† |
| Code ExecutionæœåŠ¡ | **å½“å‰å¼€å‘** | ä»£ç æ‰§è¡Œã€ç»“æœæ•è· |
| Data Analyst Agent | **å½“å‰å¼€å‘** | Agentæ ¸å¿ƒé€»è¾‘ã€LLMé›†æˆ |
| æ–‡ä»¶å¤„ç† | **å½“å‰å¼€å‘** | æ–‡ä»¶ä¸Šä¼ ã€æ•°æ®é›†åŠ è½½ |
| è®¿é—®æ§åˆ¶ | **åä½œäººå‘˜** | ç§æœ‰/å…¬å…±Assistantæƒé™ç®¡ç† |
| å‰ç«¯UI | **åä½œäººå‘˜** | E2B Assistantç•Œé¢å±•ç¤º |
| é…ç½®ç®¡ç† | **åä½œäººå‘˜** | ç¯å¢ƒå˜é‡ã€é…ç½®æ–‡ä»¶ |

---

## 3. æŠ€æœ¯æ ˆ

### 3.1 æ ¸å¿ƒä¾èµ–
- **E2B Code Interpreter SDK**: `@e2b/code-interpreter` (v2.8.4+)
- **OpenAI API**: `openai` (v4.x) - ç”¨äº LLM æ¨ç†ï¼ˆGPT-4, GPT-4o ç­‰æ¨¡å‹ï¼‰
- **MongoDB**: å­˜å‚¨ Assistant é…ç½®ã€å¯¹è¯å†å²ã€æ–‡ä»¶å…ƒæ•°æ®
- **Node.js/Express.js**: åç«¯æ¡†æ¶ï¼ˆv18+ï¼‰

### 3.2 LLM è¯´æ˜
æœ¬é¡¹ç›®ä½¿ç”¨ **OpenAI API** è¿›è¡Œæ¨ç†ï¼Œæ”¯æŒçš„æ¨¡å‹åŒ…æ‹¬ï¼š
- GPT-4 / GPT-4-turbo
- GPT-4o / GPT-4o-mini
- æˆ–ä»»ä½•å…¼å®¹ OpenAI API çš„æ¨¡å‹ï¼ˆå¦‚é€šè¿‡ä»£ç†è®¿é—®çš„å…¶ä»–æ¨¡å‹ï¼‰

---

## 4. ç›®å½•ç»“æ„è§„åˆ’

```
LibreChat/
â”œâ”€â”€ api/
â”‚   â”œâ”€â”€ models/
â”‚   â”‚   â””â”€â”€ E2BAssistant.js              # [å·²å®ç°] E2B Assistantæ•°æ®æ¨¡å‹
â”‚   â”œâ”€â”€ server/
â”‚   â”‚   â”œâ”€â”€ services/
â”‚   â”‚   â”‚   â”œâ”€â”€ Agents/
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ e2bAgent/
â”‚   â”‚   â”‚   â”‚       â”œâ”€â”€ index.js           # [å·²å®ç°] 446è¡Œ - ReActå¾ªç¯Agentæ ¸å¿ƒ
â”‚   â”‚   â”‚   â”‚       â”œâ”€â”€ contextManager.js  # [å·²å®ç°] 387è¡Œ - ä¸Šä¸‹æ–‡ç®¡ç†å™¨ 
â”‚   â”‚   â”‚   â”‚       â”œâ”€â”€ prompts.js         # [å·²å®ç°] 154è¡Œ - ç³»ç»Ÿæç¤ºè¯
â”‚   â”‚   â”‚   â”‚       â””â”€â”€ tools.js           # [å·²å®ç°] 266è¡Œ - å·¥å…·å®šä¹‰ä¸æ‰§è¡Œ
â”‚   â”‚   â”‚   â”œâ”€â”€ Endpoints/
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ e2bAssistants/
â”‚   â”‚   â”‚   â”‚       â”œâ”€â”€ index.js           # [å·²å®ç°] ç«¯ç‚¹å…¥å£
â”‚   â”‚   â”‚   â”‚       â”œâ”€â”€ initialize.js      # [å·²å®ç°] 748è¡Œ - E2Bæ²™ç®±ç”Ÿå‘½å‘¨æœŸç®¡ç†
â”‚   â”‚   â”‚   â”‚       â””â”€â”€ buildOptions.js    # [å·²å®ç°] é€‰é¡¹æ„å»º
â”‚   â”‚   â”‚   â”œâ”€â”€ Sandbox/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ codeExecutor.js        # [å·²å®ç°] 163è¡Œ - Pythonä»£ç æ‰§è¡Œ
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ fileHandler.js         # [å·²å®ç°] 172è¡Œ - æ–‡ä»¶åŒæ­¥ä¸æŒä¹…åŒ–
â”‚   â”‚   â””â”€â”€ routes/
â”‚   â”‚       â””â”€â”€ e2bAssistants/
â”‚   â”‚           â”œâ”€â”€ index.js               # [å·²å®ç°] è·¯ç”±æ³¨å†Œ
â”‚   â”‚           â””â”€â”€ controller.js          # [å·²å®ç°] 619è¡Œ - HTTP/SSEæ§åˆ¶å™¨
â”‚   â””â”€â”€ tests/
â”‚       â””â”€â”€ e2b/
â”‚           â”œâ”€â”€ codeExecutor.test.js       # [å·²å®ç°] CodeExecutorå•å…ƒæµ‹è¯•
â”‚           â”œâ”€â”€ fileHandler.test.js        # [å·²å®ç°] FileHandlerå•å…ƒæµ‹è¯•
â”‚           â”œâ”€â”€ real_integration.js        # [å·²å®ç°] çœŸå®ç¯å¢ƒç«¯åˆ°ç«¯æµ‹è¯•
â”‚           â””â”€â”€ debug_sandbox.js           # [å·²å®ç°] æ²™ç®±è°ƒè¯•è„šæœ¬
â”œâ”€â”€ packages/
â”‚   â””â”€â”€ data-schemas/
â”‚       â”œâ”€â”€ src/
â”‚       â”‚   â”œâ”€â”€ schema/
â”‚       â”‚   â”‚   â””â”€â”€ e2bAssistant.ts        # [å·²å®ç°] E2B Assistant Schema
â”‚       â”‚   â”œâ”€â”€ models/
â”‚       â”‚   â”‚   â””â”€â”€ e2bAssistant.ts        # [å·²å®ç°] E2B Assistant Model
â”‚       â”‚   â””â”€â”€ types/
â”‚       â”‚       â””â”€â”€ e2bAssistant.ts        # [å·²å®ç°] TypeScriptç±»å‹å®šä¹‰
â”œâ”€â”€ docs/
â”‚   â”œâ”€â”€ E2B_AGENT_ARCHITECTURE.md          # [å·²å®ç°] ç³»ç»Ÿæ¶æ„æ–‡æ¡£
â”‚   â”œâ”€â”€ E2B_AGENT_FIXES.md                 # [å·²å®ç°] é—®é¢˜è§£å†³æ–‡æ¡£
â”‚   â”œâ”€â”€ E2B_DATA_ANALYST_AGENT_DEVELOPMENT.md # [æœ¬æ–‡æ¡£] å¼€å‘æ–‡æ¡£
â”‚   â””â”€â”€ E2B_AGENT_TEST_CASES.md            # [å·²å®ç°] æµ‹è¯•ç”¨ä¾‹
```

---

## 5. æ ¸å¿ƒæ¨¡å—å®ç°è¯¦æƒ…

### 5.1 Context Manager (`contextManager.js`) 
- **åŠŸèƒ½**: ä¸Šä¸‹æ–‡ç®¡ç†çš„ Single Source of Truth
- **ä»£ç **: 387 è¡Œ
- **èŒè´£**:
  - **å†…éƒ¨/å¤–éƒ¨IDåˆ†ç¦»**: å­˜å‚¨å¸¦UUIDçš„ file_idï¼Œå¯¹å¤–åªæš´éœ²å¹²å‡€æ–‡ä»¶å
  - **ä¸Šä¸‹æ–‡ç”Ÿæˆ**: ä¸º LLM ç”Ÿæˆç»“æ„åŒ–ä¸Šä¸‹æ–‡ï¼ˆæ–‡ä»¶åˆ—è¡¨ã€å¯¹è¯å†å²ã€å·¥ä»¶ä¿¡æ¯ï¼‰
  - **é”™è¯¯æ¢å¤**: æä¾›åˆ†å±‚é”™è¯¯å»ºè®®ï¼ˆå…³é”®é”™è¯¯ + é€šç”¨è°ƒè¯•ï¼‰
  - **conversationIdè¿½è¸ª**: é˜²æ­¢è·¨å¯¹è¯æ··æ·†
- **å…³é”®æ–¹æ³•**:
  - `getContextForIteration()`: ç”Ÿæˆå½“å‰è¿­ä»£çš„å®Œæ•´ä¸Šä¸‹æ–‡
  - `updateFileContext()`: æ›´æ–°æ–‡ä»¶æ˜ å°„
  - `generateErrorGuidance()`: ç”Ÿæˆé”™è¯¯æ¢å¤å»ºè®®

### 5.2 E2BDataAnalystAgent (`index.js`)
- **åŠŸèƒ½**: åŸºäº ReAct å¾ªç¯çš„æ™ºèƒ½ä»£ç†æ ¸å¿ƒ
- **ä»£ç **: 446 è¡Œ
- **LLM**: ä½¿ç”¨ **OpenAI API**ï¼ˆGPT-4/GPT-4oï¼‰
- **ç‰¹æ€§**:
  - **ReActå¾ªç¯**: Thought â†’ Action â†’ Observation â†’ æœ€å¤š20æ¬¡è¿­ä»£
  - **æ²™ç®±å¤ç”¨**: åŒä¸€å¯¹è¯ä½¿ç”¨ç›¸åŒæ²™ç®±å®ä¾‹
  - **åŒå±‚æ¢å¤**: Layer 1 (åˆå§‹åŒ–) + Layer 2 (æ‰§è¡Œæ—¶)
  - **è‡ªæ„ˆèƒ½åŠ›**: é”™è¯¯è‡ªåŠ¨åé¦ˆç»™ LLMï¼Œé€šè¿‡é€šç”¨è°ƒè¯•ç­–ç•¥è‡ªä¸»ä¿®å¤
  - **å·¥å…·è°ƒç”¨**: `execute_code`, `upload_file`ï¼ˆå·²ç§»é™¤å†—ä½™çš„ download_fileï¼‰
  - **æµå¼è¾“å‡º**: æ”¯æŒ SSE é€ token è¿”å›

### 5.3 E2B Sandbox Manager (`initialize.js`)
- **åŠŸèƒ½**: ç®¡ç† E2B æ²™ç®±ç”Ÿå‘½å‘¨æœŸï¼ˆåˆ›å»ºã€é”€æ¯ã€é‡ç”¨ï¼‰
- **ä»£ç **: 748 è¡Œ
- **SDKé€‚é…**: é€‚é…äº† `@e2b/code-interpreter` v2.8.4
- **å…³é”®ç‰¹æ€§**:
  - ä½¿ç”¨ `Sandbox.create()` å’Œ `sandbox.kill()`
  - æ–‡ä»¶æ“ä½œï¼š`.files.write()`, `.files.read()` ä¸å¼‚æ­¥æµå¤„ç†
  - é…ç½®ï¼šé»˜è®¤ `secure: false` ä»¥å¢å¼ºå…¼å®¹æ€§
  - æ™ºèƒ½æ¨¡æ¿é€‰æ‹©ï¼šæ”¯æŒè‡ªå®šä¹‰æ¨¡æ¿æˆ–é»˜è®¤æ¨¡æ¿
  - **åŒå±‚æ–‡ä»¶æ¢å¤**:
    * Layer 1: processMessage æ£€æµ‹æ²™ç®±è¿‡æœŸå¹¶æ¢å¤æ–‡ä»¶
    * Layer 2: tools.js æ‰§è¡Œè¶…æ—¶æ£€æµ‹å¹¶é‡å»ºæ²™ç®±

### 5.4 Tools (`tools.js`)
- **åŠŸèƒ½**: å·¥å…·å®šä¹‰ä¸æ‰§è¡Œé€»è¾‘
- **ä»£ç **: 266 è¡Œ
- **å·¥å…·åˆ—è¡¨**:
  - `execute_code`: æ‰§è¡Œ Python ä»£ç ï¼Œè‡ªåŠ¨æ•è·å›¾è¡¨
  - `upload_file`: ä¸Šä¼ æ–‡ä»¶åˆ°æ²™ç®±
- **å…³é”®æ”¹è¿›**:
  - **ç»Ÿä¸€è§‚å¯Ÿæ ¼å¼**: æˆåŠŸ/å¤±è´¥éƒ½è¿”å›å®Œæ•´ç»“æ„ï¼ˆæ¶ˆé™¤æ— é™å¾ªç¯ï¼‰
  - **Layer 2 æ¢å¤**: æ•è·æ²™ç®±è¶…æ—¶å¹¶è‡ªåŠ¨é‡å»º
  - **è·¯å¾„ç®€åŒ–**: ç›´æ¥åœ¨ observation ä¸­æä¾›æ­£ç¡®çš„ Web è·¯å¾„

### 5.5 CodeExecutor (`codeExecutor.js`)
- **åŠŸèƒ½**: åœ¨æ²™ç®±ä¸­æ‰§è¡Œ Python ä»£ç ï¼Œå¤„ç† `stdout`/`stderr`ï¼Œå¹¶æå–ç”Ÿæˆçš„å›¾è¡¨
- **ä»£ç **: 163 è¡Œ
- **ç‰¹æ€§**: 
  - **å›¾è¡¨æå–**: è‡ªåŠ¨ä» execution results ä¸­æå– PNG/JPEG/SVG æ ¼å¼çš„å›¾ç‰‡
  - **å®‰å…¨æ ¡éªŒ**: åŸºç¡€ä»£ç å®‰å…¨æ£€æŸ¥ï¼Œæ‹¦æˆªå±é™©å‡½æ•°ï¼ˆå¦‚ `os.system`ï¼‰
  - **æ‰¹é‡æ‰§è¡Œ**: æ”¯æŒæŒ‰é¡ºåºæ‰§è¡Œå¤šä¸ªä»£ç å—
  - **é”™è¯¯æ•è·**: å®Œæ•´çš„ traceback ä¼ é€’

### 5.6 FileHandler (`fileHandler.js`)
- **åŠŸèƒ½**: å¤„ç† LibreChat ç³»ç»Ÿå­˜å‚¨ä¸ E2B æ²™ç®±ä¹‹é—´çš„æ–‡ä»¶åŒæ­¥
- **ä»£ç **: 172 è¡Œ
- **ç‰¹æ€§**:
  - **å¤šå­˜å‚¨æ”¯æŒ**: å…¼å®¹ Local, S3, Azure Blob Storage
  - **Artifacts æŒä¹…åŒ–**: å°†æ²™ç®±ç”Ÿæˆçš„å›¾ç‰‡/CSV ä¸‹è½½å¹¶ä¿å­˜åˆ°ç³»ç»Ÿå­˜å‚¨
  - **å†…å­˜æŒä¹…åŒ–**: æ”¯æŒç›´æ¥å°† Buffer ä¿å­˜ï¼Œæ— éœ€é‡å¤ä¸‹è½½
  - **UUIDå‰¥ç¦»**: ä¸Šä¼ åˆ°æ²™ç®±æ—¶ç§»é™¤æ–‡ä»¶åä¸­çš„ UUID å‰ç¼€
  - **æ²™ç®±æ–‡ä»¶æ¢å¤**: ä»æ•°æ®åº“é‡æ–°ä¸Šä¼ æ‰€æœ‰æ–‡ä»¶åˆ°æ–°æ²™ç®±

### 5.7 Controller (`controller.js`)
- **åŠŸèƒ½**: HTTP/SSE è¯·æ±‚å¤„ç†
- **ä»£ç **: 619 è¡Œ
- **ç‰¹æ€§**:
  - **SSE æµå¼**: åˆ›å»º SSE è¿æ¥ï¼Œé€ token è¿”å›
  - **æ¶ˆæ¯æŒä¹…åŒ–**: ä¿å­˜ç”¨æˆ·æ¶ˆæ¯å’Œ Agent å“åº”åˆ° MongoDB
  - **å†å²åŠ è½½**: å¤šè½®å¯¹è¯æ—¶åŠ è½½å†å²æ¶ˆæ¯
  - **é”™è¯¯å¤„ç†**: ç»Ÿä¸€é”™è¯¯å“åº”æ ¼å¼

---

## 6. ç³»ç»Ÿé›†æˆç‚¹

### 6.1 ç«¯ç‚¹æ³¨å†Œ
- **Enum**: åœ¨ `packages/data-provider/src/schemas.ts` æ·»åŠ äº† `EModelEndpoint.e2bAssistants`ã€‚
- **Index**: åœ¨ `api/server/services/Endpoints/index.js` æ³¨å†Œäº†åˆå§‹åŒ–å…¥å£ã€‚
- **Config**: åœ¨ `api/server/services/Config/EndpointService.js` æ·»åŠ äº†é…ç½®ç”Ÿæˆé€»è¾‘ã€‚

### 6.2 åŠ©æ‰‹é€»è¾‘é›†æˆ
- **Helpers**: åœ¨ `api/server/controllers/assistants/helpers.js` ä¸­æ·»åŠ äº†å¯¹ `e2bAssistants` çš„æ”¯æŒï¼š
  - `getOpenAIClient`: è·¯ç”±åˆ° E2B çš„åˆå§‹åŒ–é€»è¾‘ï¼Œå¹¶ç¡®ä¿åˆå§‹åŒ– OpenAI å®¢æˆ·ç«¯è¿›è¡Œ Agent æ¨ç†ã€‚
  - `fetchAssistants`: ä» `E2BAssistant` æ¨¡å‹è·å–åŠ©æ‰‹åˆ—è¡¨ã€‚

---

## 7. è‡ªå®šä¹‰æ¨¡æ¿ä¸é¢„è£…åŒ… (é‡è¦ ğŸ’¡)

### 7.1 æ¨¡æ¿ç³»ç»Ÿ (V2)
æœ¬é¡¹ç›®é‡‡ç”¨ E2B æœ€æ–°çš„ **TypeScript æ¨¡æ¿ç³»ç»Ÿ**ã€‚æ¨¡æ¿å®šä¹‰ä½äº `e2b_template/data-analyst/template.ts`ã€‚è¿™ç§æ–¹å¼æ¯”æ—§çš„ Dockerfile æ›´çµæ´»ï¼Œæ”¯æŒç¼–ç¨‹å¼å®šä¹‰ç¯å¢ƒã€‚

### 7.2 æ„å»ºä¸å‘å¸ƒæ­¥éª¤
å¦‚æœéœ€è¦æ·»åŠ æ–°çš„ Python åŒ…ï¼ˆå¦‚ `lightgbm`ï¼‰æˆ–ç³»ç»Ÿä¾èµ–ï¼š

1.  **ä¿®æ”¹æ¨¡æ¿å®šä¹‰**:
    ç¼–è¾‘ `e2b_template/data-analyst/template.ts`:
    ```typescript
    // ç¤ºä¾‹ï¼šæ·»åŠ æ–°çš„ Python åŒ…
    .run("pip install lightgbm")
    ```

2.  **æ„å»ºæ¨¡æ¿**:
    ```bash
    cd e2b_template/data-analyst
    npm install
    # æ„å»ºå¼€å‘ç‰ˆ (Dev)
    npm run e2b:build:dev
    # æˆ–æ„å»ºç”Ÿäº§ç‰ˆ (Prod)
    # npm run e2b:build:prod
    ```

3.  **è·å– Template ID**:
    æ„å»ºæˆåŠŸåï¼Œæ§åˆ¶å°ä¼šè¾“å‡º Template ID (å¦‚ `xed696qfsyzpaei3ulh5`)ã€‚

4.  **é…ç½®ä½¿ç”¨**:
    å°†æ–°çš„ Template ID æ›´æ–°åˆ° `.env` æ–‡ä»¶ä¸­ï¼š
    ```bash
    E2B_SANDBOX_TEMPLATE=xed696qfsyzpaei3ulh5
    ```

---

## 8. æ•…éšœæ’é™¤ (Troubleshooting)

### 8.1 502: The sandbox is running but port is not open
*   **åŸå› **ï¼šæ²™ç®±å†…çš„ä»£ç è§£é‡Šå™¨è¿›ç¨‹æœªå¯åŠ¨ã€‚
*   **è§£å†³æ–¹æ³•**ï¼š
    1.  **æ£€æŸ¥ Template ID**ï¼šç¡®ä¿ `.env` ä¸­çš„ ID å¯¹åº”çš„æ˜¯åŸºäº `code-interpreter` æ„å»ºçš„æ¨¡æ¿ã€‚
    2.  **é‡æ–°æ„å»º**ï¼šå¦‚æœæ¨¡æ¿æŸåï¼Œé‡æ–°è¿è¡Œæ„å»ºå‘½ä»¤ç”Ÿæˆæ–° IDã€‚

### 8.2 400: Template is not compatible with secured access
*   **åŸå› **ï¼šE2B API Key å¼€å¯äº†â€œå®‰å…¨è®¿é—®â€é™åˆ¶ã€‚
*   **è§£å†³æ–¹æ³•**ï¼šæˆ‘ä»¬åœ¨ä»£ç ä¸­å·²é»˜è®¤è®¾ç½® `secure: false`ã€‚å¦‚æœé—®é¢˜ä¾æ—§ï¼Œè¯·æ£€æŸ¥ E2B Dashboard çš„ API Key è®¾ç½®ã€‚

---

## 9. å‰ç«¯é›†æˆçŠ¶æ€ä¸å·²çŸ¥é—®é¢˜ (2026-01-04)

### 9.1 å·²å®Œæˆçš„é›†æˆ âœ…
- **å›¾æ ‡æ”¯æŒ**: E2B Assistants ç°åœ¨ä½¿ç”¨ Sparkles (âœ¨) å›¾æ ‡ã€‚
- **åŠ©æ‰‹åˆ›å»º**: ä¿®å¤äº† JSON è§£æé”™è¯¯ï¼ŒåŠ©æ‰‹å¯ä»¥æˆåŠŸåˆ›å»ºå¹¶ä¿å­˜åˆ°æ•°æ®åº“ã€‚
- **åç«¯è·¯ç”±**: è¡¥å…¨äº† `/documents` å’Œ `/tools` ç«¯ç‚¹ï¼Œæ¶ˆé™¤äº†å‰ç«¯ 404 é”™è¯¯ã€‚
- **åŠ©æ‰‹åˆ—è¡¨**: ä¿®å¤ API å“åº”æ ¼å¼ï¼Œåˆ·æ–°åå¯æ­£ç¡®æ˜¾ç¤ºå·²åˆ›å»ºçš„åŠ©æ‰‹ã€‚
- **æ–‡ä»¶ä¸Šä¼ **: å®Œæ•´å®ç°æ–‡ä»¶ä¸Šä¼ åˆ° E2B æ²™ç®±åŠŸèƒ½ï¼Œæ”¯æŒå¤šç§å­˜å‚¨åç«¯ï¼ˆLocal/S3/Azureï¼‰ã€‚
- **æ¶ˆæ¯æµ**: SSE æ¶ˆæ¯æ ¼å¼å®Œå…¨å¯¹é½å‰ç«¯é¢„æœŸï¼Œå®ç° created å’Œ final äº‹ä»¶ã€‚
- **æ•°æ®æŒä¹…åŒ–**: ç”¨æˆ·æ¶ˆæ¯å’Œå“åº”æ¶ˆæ¯æ­£ç¡®ä¿å­˜åˆ°æ•°æ®åº“ã€‚

### 9.2 ä¿®å¤çš„å…³é”® Bug âœ…

#### âœ… 1. æ–‡ä»¶ä¸Šä¼ å¤±è´¥ (å·²ä¿®å¤)
- **é—®é¢˜**: `Cannot read properties of undefined (reading 'paths')`
- **åŸå› **: E2B è·¯ç”±ç¼ºå°‘ `configMiddleware`ï¼Œå¯¼è‡´ `req.config` æœªåˆå§‹åŒ–
- **ä¿®å¤**: åœ¨è·¯ç”±ä¸­æ·»åŠ  `configMiddleware`ï¼Œç¡®ä¿é…ç½®æ­£ç¡®åŠ è½½

#### âœ… 2. å‰ç«¯æ— è¾“å‡º (å·²ä¿®å¤)
- **é—®é¢˜**: æ¶ˆæ¯å‘é€åå‰ç«¯æ— å“åº”ï¼Œæ˜¾ç¤º "2/2" ä½†æ— å†…å®¹
- **åŸå› **: SSE æ¶ˆæ¯æ ¼å¼ä¸ç¬¦åˆå‰ç«¯é¢„æœŸï¼Œç¼ºå°‘å¿…éœ€å­—æ®µ
- **ä¿®å¤**: 
  - å®ç°å®Œæ•´çš„ SSE äº‹ä»¶æµï¼ˆcreated â†’ finalï¼‰
  - æ·»åŠ  conversation, requestMessage, responseMessage
  - ä½¿ç”¨ `sanitizeMessageForTransmit` æ¸…ç†æ¶ˆæ¯

#### âœ… 3. åŠ©æ‰‹åˆ—è¡¨ä¸æ˜¾ç¤º (å·²ä¿®å¤)
- **é—®é¢˜**: åˆ·æ–°é¡µé¢åçœ‹ä¸åˆ°å·²åˆ›å»ºçš„åŠ©æ‰‹
- **åŸå› **: API è¿”å›æ•°ç»„è€Œé `{ data: [...] }` æ ¼å¼
- **ä¿®å¤**: ç»Ÿä¸€ API å“åº”æ ¼å¼ï¼Œä¸ Azure Assistants ä¿æŒä¸€è‡´

#### âœ… 4. åŠ©æ‰‹é…ç½®ä¿å­˜é—®é¢˜ (å·²ä¿®å¤ - 2026-01-04)
- **é—®é¢˜**: åˆ›å»ºåŠ©æ‰‹ååˆ·æ–°é¡µé¢ï¼Œéƒ¨åˆ†é…ç½®å­—æ®µé‡ç½®ï¼ˆdescriptionã€instructionsã€conversation_startersã€append_current_datetimeã€toolsç­‰ï¼‰
- **åŸå› **: 
  - Schemaç¼ºå°‘ `append_current_datetime`ã€`tools`ã€`tool_resources` å­—æ®µå®šä¹‰
  - Controllerçš„ get/list/update æ–¹æ³•æœªæ˜ å°„æ‰€æœ‰å­—æ®µ
  - `instructions` â†” `prompt` å­—æ®µæ˜ å°„ä¸å®Œæ•´
- **ä¿®å¤**:
  - åœ¨ `e2bAssistantSchema` ä¸­æ·»åŠ ç¼ºå¤±å­—æ®µï¼ˆappend_current_datetimeã€toolsã€tool_resourcesï¼‰
  - åœ¨ `createAssistant` ä¸­ä¿å­˜æ‰€æœ‰å‰ç«¯å‘é€çš„å­—æ®µ
  - åœ¨ `getAssistant`/`listAssistants` ä¸­è¿”å›å®Œæ•´å­—æ®µæ˜ å°„å¹¶è®¾ç½®é»˜è®¤å€¼
  - åœ¨ `updateAssistant` ä¸­ä½¿ç”¨ç™½åå•æ–¹å¼å¤„ç†æ‰€æœ‰å¯æ›´æ–°å­—æ®µ

#### âœ… 5. å¯¹è¯å†å²ä¸¢å¤±é—®é¢˜ (å·²ä¿®å¤ - 2026-01-04)
- **é—®é¢˜**: åŒä¸€å¯¹è¯ä¸­çš„ç¬¬äºŒæ¡æ¶ˆæ¯ä¸è®°å¾—ç¬¬ä¸€æ¡è¯´äº†ä»€ä¹ˆ
- **åŸå› **: `chat` ç«¯ç‚¹è°ƒç”¨ `agent.processMessage(text)` æ—¶æœªä¼ é€’å†å²æ¶ˆæ¯
- **ä¿®å¤**:
  - åœ¨ `controller.js` ä¸­æ·»åŠ  `getMessages` å¯¼å…¥
  - åœ¨è°ƒç”¨ `processMessage` å‰ä½¿ç”¨ `getMessages` åŠ è½½å¯¹è¯å†å²
  - å°†å†å²æ¶ˆæ¯è½¬æ¢ä¸º OpenAI æ ¼å¼ï¼ˆrole: user/assistantï¼‰å¹¶ä¼ é€’ç»™ Agent

#### âœ… 6. å›¾åƒè·¯å¾„æ›¿æ¢å¤±è´¥ (å·²ä¿®å¤ - 2026-01-04)
- **é—®é¢˜**: LLMç”Ÿæˆçš„sandbox:è·¯å¾„æ— æ³•åœ¨å‰ç«¯æ˜¾ç¤ºå›¾åƒ
- **åŸå› **: 
  - `image_url_map` ä¸­çš„è·¯å¾„æ¨¡å¼ä¸å¤Ÿå…¨é¢
  - ä»…ä½¿ç”¨ç²¾ç¡®åŒ¹é…ï¼Œæ— æ³•å¤„ç†LLMç”Ÿæˆçš„å„ç§è·¯å¾„æ ¼å¼
- **ä¿®å¤**:
  - åœ¨ `tools.js` ä¸­æ·»åŠ æ›´å¤šsandboxè·¯å¾„æ¨¡å¼ï¼ˆsandbox:/ã€sandbox://ã€/tmp/ç­‰ï¼‰
  - åœ¨ `index.js` ä¸­æ·»åŠ ä¸¤å±‚æ›¿æ¢ç­–ç•¥ï¼š
    1. ç²¾ç¡®åŒ¹é… `image_url_map` ä¸­çš„æ‰€æœ‰æ¨¡å¼
    2. ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼åŒ¹é…ä»»ä½•åŒ…å«å›¾åƒæ–‡ä»¶åçš„sandbox:æˆ–æ–‡ä»¶è·¯å¾„
  - å­˜å‚¨ `image_names` å’Œ `image_actual_paths` ç”¨äºæ¨¡å¼åŒ¹é…

### 9.3 å½“å‰åŠŸèƒ½çŠ¶æ€

| åŠŸèƒ½ | çŠ¶æ€ | è¯´æ˜ |
|------|------|------|
| åŠ©æ‰‹åˆ›å»º | âœ… å®Œæˆ | æ”¯æŒé€šè¿‡ Builder åˆ›å»ºåŠ©æ‰‹ |
| åŠ©æ‰‹é…ç½®ä¿å­˜ | âœ… å®Œæˆ | æ‰€æœ‰é…ç½®å­—æ®µæ­£ç¡®æŒä¹…åŒ– |
| åŠ©æ‰‹åˆ—è¡¨ | âœ… å®Œæˆ | åˆ·æ–°åæ­£ç¡®æ˜¾ç¤º |
| æ–‡ä»¶ä¸Šä¼  | âœ… å®Œæˆ | æ”¯æŒ Local/S3/Azure å­˜å‚¨ |
| ä»£ç æ‰§è¡Œ | âœ… å®Œæˆ | E2B æ²™ç®±æ‰§è¡Œ Python ä»£ç  |
| å›¾åƒç”Ÿæˆ | âœ… å®Œæˆ | è‡ªåŠ¨æå–å¹¶æ˜¾ç¤ºmatplotlib/seabornå›¾è¡¨ |
| æ¶ˆæ¯æ˜¾ç¤º | âœ… å®Œæˆ | SSE æµå¼è¿”å›æ¶ˆæ¯ |
| æ•°æ®æŒä¹…åŒ– | âœ… å®Œæˆ | æ¶ˆæ¯ä¿å­˜åˆ° MongoDB |
| å†å²å¯¹è¯ | âœ… å®Œæˆ | å¤šè½®å¯¹è¯ä¿æŒä¸Šä¸‹æ–‡ |
| æ²™ç®±å¤ç”¨ | âœ… å®Œæˆ | åŒä¸€å¯¹è¯å¤ç”¨æ²™ç®±å®ä¾‹ |

### 9.4 å¾…ä¼˜åŒ–åŠŸèƒ½

- **æµå¼å“åº”**: å½“å‰å·²å®ç°åŸºç¡€æµå¼ï¼ˆé€ token è¾“å‡ºï¼‰ï¼Œå¯è¿›ä¸€æ­¥ä¼˜åŒ–æ€§èƒ½
- **é”™è¯¯é‡è¯•**: å¢å¼º LLM å·¥å…·è°ƒç”¨å¤±è´¥çš„é‡è¯•æœºåˆ¶
- **Token ä¼˜åŒ–**: å‡å°‘ç³»ç»Ÿæç¤ºè¯å’Œå·¥å…·å®šä¹‰çš„ Token æ¶ˆè€—
- **è®¿é—®æ§åˆ¶**: å®ç°ç§æœ‰/å…¬å…±åŠ©æ‰‹æƒé™ç®¡ç†ï¼ˆå¾…åä½œäººå‘˜å®Œæˆï¼‰

---

## 10. 2026-01-07 æ¶æ„ä¼˜åŒ–ä¸å…³é”®ä¿®å¤

### 10.1 å›¾ç‰‡è·¯å¾„æ¶æ„ç®€åŒ– â­

**é—®é¢˜èƒŒæ™¯**ï¼š
å›¾ç‰‡è·¯å¾„å‡ºç°åŒé‡åµŒå¥—ï¼Œå¦‚ `/images/userId/timestamp-/images/userId/timestamp-plot-0.png`

**æ ¹æœ¬åŸå› **ï¼š
1. LLM åœ¨å¤šè½®å¯¹è¯ä¸­ä¼šå¼•ç”¨ä¹‹å‰ç”Ÿæˆçš„å›¾ç‰‡è·¯å¾„
2. è·¯å¾„æ›¿æ¢é€»è¾‘ä¼šåŒ¹é…åˆ°å·²ç»æ­£ç¡®çš„è·¯å¾„ä¸­çš„å­ä¸²ï¼ˆå¦‚ `plot-0.png`ï¼‰
3. å¯¼è‡´å¯¹æ­£ç¡®è·¯å¾„å†æ¬¡è¿›è¡Œæ›¿æ¢ï¼Œé€ æˆåµŒå¥—

**è§£å†³æ–¹æ¡ˆ** - æ¶æ„çº§ç®€åŒ–ï¼š
```javascript
// åœ¨ tools.js ä¸­ç›´æ¥æä¾›æ­£ç¡®è·¯å¾„
observation.image_paths = persistedFiles.map(f => f.filepath);
observation.images_markdown = persistedFiles.map((f, i) => 
  `![Plot ${i}](${f.filepath})`
).join('\n');

// åœ¨ index.js ä¸­å®Œå…¨ç§»é™¤è·¯å¾„æ›¿æ¢
const processedText = finalContent; // ç›´æ¥ä½¿ç”¨ï¼Œä¸åšä»»ä½•æ›¿æ¢
```

**å½±å“èŒƒå›´**ï¼š
- `api/server/services/Agents/e2bAgent/tools.js` - å¢å¼º observation æ ¼å¼
- `api/server/services/Agents/e2bAgent/index.js` - ç§»é™¤ `replaceImagePaths()` é€»è¾‘
- `api/server/services/Agents/e2bAgent/prompts.js` - æ›´æ–° System Prompt

### 10.2 æ— é™é‡è¯•å¾ªç¯ä¿®å¤ â­

**é—®é¢˜è¡¨ç°**ï¼š
```
iteration 1: execute_code -> fetch failed
iteration 2-10: é‡å¤æ‰§è¡Œç›¸åŒä»£ç 
æœ€ç»ˆ: Reached max iterations (10)
```

**æ ¹æœ¬åŸå› **ï¼š
ä»£ç æ‰§è¡Œå¤±è´¥æ—¶è¿”å›çš„ observation æ ¼å¼ä¸ä¸€è‡´ï¼š
- æˆåŠŸæ—¶ï¼š`{ success: true, stdout, stderr, has_plots, plot_count, image_paths, ... }`
- å¤±è´¥æ—¶ï¼š`{ success: false, error }` âš ï¸ ç¼ºå°‘å…³é”®å­—æ®µ

**è§£å†³æ–¹æ¡ˆ** - ç»Ÿä¸€æ ¼å¼ï¼š
```javascript
// æ–‡ä»¶: api/server/services/Agents/e2bAgent/tools.js
// é”™è¯¯æ—¶ä¹Ÿè¿”å›å®Œæ•´ç»“æ„
return {
  success: false,
  error: error.message,
  stdout: '',
  stderr: error.message,
  has_plots: false,
  plot_count: 0,
  image_paths: [],
  images_markdown: '',
  plot_info: ''
};
```

### 10.3 å·¥å…·ç²¾ç®€ - ç§»é™¤ download_file

**å‘ç°**ï¼š`download_file` å·¥å…·ä¸ `execute_code` çš„è‡ªåŠ¨å›¾ç‰‡æŒä¹…åŒ–åŠŸèƒ½å®Œå…¨å†—ä½™

**ä¿®æ”¹å†…å®¹**ï¼š
1. ä» `tools.js` ä¸­ç§»é™¤ `download_file` å‡½æ•°
2. ä» `prompts.js` ä¸­ç§»é™¤å·¥å…·å®šä¹‰
3. æ›´æ–° System Promptï¼Œå¼ºè°ƒè‡ªåŠ¨å›¾ç‰‡æŒä¹…åŒ–
4. ä¿®å¤ `initialize.js` ä¸­çš„ E2B downloadFile API é”™è¯¯

**API ä¿®å¤**ï¼š
```javascript
// ä¿®å¤å‰
const content = await sandboxData.sandbox.files.read(path, { format });

// ä¿®å¤å
const response = await sandboxData.sandbox.files.read(path, { format });
let content;
if (format === 'buffer') {
  const arrayBuffer = await response.arrayBuffer();
  content = Buffer.from(arrayBuffer);
} else {
  content = await response.text();
}
```

### 10.4 Debug æ—¥å¿—å¢å¼º

ä¸ºè¯Šæ–­å¤æ‚é—®é¢˜ï¼ˆå¦‚é«˜çº§ç»Ÿè®¡åˆ†æå¤±è´¥ï¼‰ï¼Œæ·»åŠ äº†å…¨é¢çš„ debug æ—¥å¿—ï¼š

**codeExecutor.js**ï¼š
```javascript
logger.debug(`[CodeExecutor] Full result:`, JSON.stringify({
  success, 
  stdout: stdout?.substring(0, 500), 
  stderr: stderr?.substring(0, 500),
  error, 
  hasVisualization, 
  imageCount
}, null, 2));
```

**tools.js**ï¼š
```javascript
// æˆåŠŸæ—¶
logger.debug(`[E2BAgent Tools] Full observation:`, JSON.stringify(observation, null, 2));

// å¤±è´¥æ—¶
logger.debug(`[E2BAgent Tools] Error observation:`, JSON.stringify(errorObservation, null, 2));
```

**index.js**ï¼š
```javascript
// å·¥å…·è°ƒç”¨å‚æ•°
logger.debug(`[E2BAgent] Tool arguments:`, JSON.stringify(args, null, 2));

// å·¥å…·æ‰§è¡Œç»“æœï¼ˆæµå¼å’Œéæµå¼åˆ†åˆ«è®°å½•ï¼‰
logger.debug(`[E2BAgent] Streaming tool result:`, JSON.stringify(result, null, 2));
```

**å¯ç”¨æ–¹å¼**ï¼š
åœ¨ `.env` ä¸­æ·»åŠ  `DEBUG_LOGGING=true` æˆ–åœ¨ docker-compose.yml ä¸­è®¾ç½® `LOG_LEVEL=debug`

### 10.5 ~~å¾…è§£å†³é—®é¢˜~~ â†’ âœ… å·²éªŒè¯é€šè¿‡ (2026-01-08)

**~~é«˜çº§ç»Ÿè®¡åˆ†æå¤±è´¥~~** â†’ âœ… é”™è¯¯è‡ªæ„ˆèƒ½åŠ›éªŒè¯æˆåŠŸï¼š
- ~~ç°è±¡ï¼šå¤æ‚ç»Ÿè®¡ä»»åŠ¡ï¼ˆå¡æ–¹æ£€éªŒã€Tæ£€éªŒã€æ–¹å·®åˆ†æã€ç›¸å…³æ€§çŸ©é˜µç­‰ï¼‰è¾¾åˆ° max iterations (10)~~
- âœ… **çœŸå®æµ‹è¯•ç»“æœ**: ç›¸å…³æ€§çŸ©é˜µåˆ†ææˆåŠŸå®Œæˆï¼ˆ14æ¬¡è¿­ä»£ï¼‰
- âœ… **é”™è¯¯åœºæ™¯**: `ValueError: could not convert string to float: 'Braund, Mr. Owen Harris'`
- âœ… **è‡ªä¸»ä¿®å¤æµç¨‹**:
  ```
  ç¬¬7æ¬¡è¿­ä»£: df.corr() â†’ ValueError (å­—ç¬¦ä¸²åˆ—æ— æ³•è½¬æ¢)
  ç¬¬8-10æ¬¡è¿­ä»£: è¿ç»­ NameError (correlation_matrix æœªå®šä¹‰)
  ç¬¬11-13æ¬¡è¿­ä»£: LLM åˆ†æé”™è¯¯å¹¶åº”ç”¨é€šç”¨è°ƒè¯•ç­–ç•¥
  ç¬¬14æ¬¡è¿­ä»£: df.select_dtypes(include='number').corr() â†’ æˆåŠŸ âœ…
  ```
- âœ… **éªŒè¯è¦ç‚¹**:
  - æœªä½¿ç”¨ä»»ä½•ç‰¹å®šçš„ pandas é”™è¯¯æ¢å¤ä»£ç 
  - ä»…ä¾èµ–é€šç”¨è°ƒè¯•æŒ‡å¯¼ï¼ˆæ£€æŸ¥æ•°æ®ç±»å‹ã€æŸ¥çœ‹æ•°æ®ã€é€‰æ‹©æ­£ç¡®åˆ—ï¼‰
  - LLM è‡ªä¸»å®Œæˆäº†ä»é”™è¯¯åˆ†æåˆ°ä¿®å¤çš„å®Œæ•´è¿‡ç¨‹
  - æœ€ç»ˆç”Ÿæˆç›¸å…³æ€§çƒ­åŠ›å›¾å¹¶æä¾›å®Œæ•´åˆ†æ

### 10.6 æœ¬æ¬¡ Session å®Œæ•´å·¥ä½œæ€»ç»“ (2026-01-07 ~ 2026-01-08) ğŸ“‹

**æ ¸å¿ƒæˆå°±**: ä» Bug ä¿®å¤åˆ°æ¶æ„ä¼˜åŒ–çš„ç³»ç»Ÿæ€§å®Œå–„

#### 1ï¸âƒ£ Context Manager å®Œæ•´å®ç°
**é—®é¢˜**: Agent çŠ¶æ€åˆ†æ•£ï¼ŒLLM çœ‹åˆ°æ··ä¹±çš„å†…éƒ¨ ID
**è§£å†³**:
- âœ… Single source of truth è®¾è®¡
- âœ… å†…éƒ¨å­˜å‚¨ file_id (UUIDå‰ç¼€)ï¼Œå¤–éƒ¨åªæš´éœ² clean filename
- âœ… ç»“æ„åŒ–ä¸Šä¸‹æ–‡ç”Ÿæˆï¼ˆæ–‡ä»¶ã€å·¥ä»¶ã€é”™è¯¯æ¢å¤ï¼‰
- âœ… conversationId è¿½è¸ªï¼Œé˜²æ­¢è·¨å¯¹è¯æ··æ·†

**å½±å“**: 
- LLM åªçœ‹åˆ° `/home/user/titanic.csv`ï¼Œä¸ä¼šçœ‹åˆ° `UUID__titanic.csv`
- æ˜ç¡®çš„ã€å¯é¢„æµ‹çš„ä¸Šä¸‹æ–‡ç»“æ„
- æ›´å¥½çš„å¤šè½®å¯¹è¯ä½“éªŒ

#### 2ï¸âƒ£ åŒå±‚æ²™ç®±æ¢å¤ç³»ç»Ÿ
**é—®é¢˜**: æ–‡ä»¶åœ¨æ•°æ®åº“ä¸­ä½†æ²™ç®±è¿‡æœŸåæ— æ³•è®¿é—®
**è§£å†³**:
- âœ… Layer 1 (Initialization): processMessage æ£€æµ‹å¹¶æ¢å¤æ–‡ä»¶
- âœ… Layer 2 (Execution): tools.js è¶…æ—¶æ£€æµ‹å¹¶é‡å»ºæ²™ç®±
- âœ… **Critical Fix**: ä¸ä»…æ›´æ–° Context Managerï¼Œè¿˜è¦å®é™…ä¸Šä¼ æ–‡ä»¶

**éªŒè¯**:
```
ç”¨æˆ·åˆ·æ–°é¡µé¢ â†’ æ²™ç®±å·²è¿‡æœŸ
  â†’ Agent æ£€æµ‹åˆ°æ–‡ä»¶ç¼ºå¤±
  â†’ ä»æ•°æ®åº“æŸ¥è¯¢ file_ids
  â†’ syncFilesToSandbox é‡æ–°ä¸Šä¼ 
  â†’ "Restoring 1 files to new sandbox..."
  â†’ "File uploaded successfully"
  â†’ ç”¨æˆ·æ— æ„ŸçŸ¥ï¼Œç»§ç»­åˆ†æ âœ…
```

#### 3ï¸âƒ£ è¿­ä»£æ§åˆ¶ä¼˜åŒ–
**é—®é¢˜1**: å¤æ‚åˆ†æè¾¾åˆ° 10 æ¬¡è¿­ä»£é™åˆ¶ï¼Œæ— ç»“æœè¾“å‡º
**é—®é¢˜2**: LLM æ— é™å·¥å…·è°ƒç”¨ï¼Œä¸æä¾›æ–‡å­—è¯´æ˜

**è§£å†³**:
- âœ… è¿­ä»£é™åˆ¶: 10 â†’ 20 æ¬¡ (100% æå‡)
- âœ… æé†’æœºåˆ¶: iteration 17 å¼€å§‹è­¦å‘Š
- âœ… System Prompt: å¼ºåˆ¶è¦æ±‚æ¯æ¬¡ä»£ç æ‰§è¡Œåæä¾›æ–‡å­—è¯´æ˜

**æ•ˆæœ**:
- å¤æ‚åˆ†æï¼ˆ5+ å¯è§†åŒ–ï¼‰èƒ½å¤Ÿå®Œæˆ
- LLM åœ¨æ¥è¿‘é™åˆ¶æ—¶ä¸»åŠ¨æ€»ç»“
- ç”¨æˆ·ä½“éªŒå¤§å¹…æå‡

#### 4ï¸âƒ£ é”™è¯¯æ¢å¤ç­–ç•¥é‡æ„
**æ—§æ–¹æ¡ˆ**: ä¸ºæ¯ç§é”™è¯¯ç¡¬ç¼–ç è§£å†³æ–¹æ¡ˆ
```python
if 'ValueError' in error:
    return "å…·ä½“çš„ pandas ä»£ç ä¿®å¤..."
if 'KeyError' in error:
    return "å…·ä½“çš„åˆ—åæ£€æŸ¥ä»£ç ..."
# éœ€è¦ä¸ºæ¯ç§é”™è¯¯æ·»åŠ ä»£ç 
```

**æ–°æ–¹æ¡ˆ**: åˆ†å±‚ + é€šç”¨åŒ–
```
Tier 1: å…³é”®é”™è¯¯ï¼ˆç¯å¢ƒç›¸å…³ï¼‰
  - FileNotFoundError â†’ æ˜¾ç¤ºå¯ç”¨æ–‡ä»¶
  - ImportError â†’ æ£€æŸ¥å…è®¸çš„åº“
  - matplotlib style error â†’ æ›¿ä»£æ ·å¼

Tier 2: é€šç”¨è°ƒè¯•æŒ‡å¯¼ï¼ˆæ•°æ®ç›¸å…³ï¼‰
  - è¯»å– traceback
  - æ£€æŸ¥æ•°æ®ç±»å‹ (df.dtypes)
  - æ£€æŸ¥æ•°æ®å†…å®¹ (df.head())
  - å¸¸è§é—®é¢˜æ¸…å•
  - ä¿®å¤ç­–ç•¥å»ºè®®

Tier 3: LLM è‡ªä¸»åˆ†æ
  - ç†è§£é”™è¯¯åŸå› 
  - åº”ç”¨è°ƒè¯•æŠ€å·§
  - å®æ–½ä¿®å¤
```

**ä¼˜åŠ¿**:
- âœ… å¯æ‰©å±•åˆ°æœªè§è¿‡çš„é”™è¯¯
- âœ… ä»£ç æ›´ç®€æ´ï¼ˆç§»é™¤ ~20 lines ç‰¹å®šé”™è¯¯å¤„ç†ï¼‰
- âœ… LLM å­¦ä¼šè°ƒè¯•è€Œéè®°å¿†ç­”æ¡ˆ

#### 5ï¸âƒ£ å¯è§†åŒ–é—®é¢˜ä¿®å¤
**é—®é¢˜**: LLM å°è¯• `plt.savefig('/images/plot.png')`
- æ²™ç®±ä¸­æ²¡æœ‰ /images/ ç›®å½• â†’ FileNotFoundError

**æ ¹æº**: LLM çœ‹åˆ°ç”¨æˆ·ä¾§è·¯å¾„ `/images/userId/timestamp-plot.png`
- è¯¯ä»¥ä¸ºæ²™ç®±ä¸­ä¹Ÿæœ‰è¿™ä¸ªç»“æ„

**ä¿®å¤**:
1. System Prompt æ˜ç¡®è§„åˆ™: "Just use plt.show(), DON'T save to /images/"
2. Context Manager åŠ¨æ€æé†’
3. æ‰€æœ‰å›¾ç‰‡è‡ªåŠ¨æŒä¹…åŒ–ï¼Œæ— éœ€ LLM æ‰‹åŠ¨ä¿å­˜

**æ•ˆæœ**: æ¶ˆé™¤äº†ä¸€æ•´ç±»å¸¸è§é”™è¯¯

#### 6ï¸âƒ£ å›¾ç‰‡è·¯å¾„æ¶æ„ç®€åŒ–
**æ—§æ¶æ„**: å¤æ‚çš„è·¯å¾„æ›¿æ¢
```javascript
// LLM ç”Ÿæˆ sandbox: æˆ–å…¶ä»–è·¯å¾„
// Agent ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼æ›¿æ¢ä¸º /images/userId/...
// é—®é¢˜: å¤šè½®å¯¹è¯ä¸­å¼•ç”¨å†å²è·¯å¾„ â†’ é‡å¤æ›¿æ¢ â†’ åµŒå¥—
```

**æ–°æ¶æ„**: ç›´æ¥æä¾›æ­£ç¡®è·¯å¾„
```javascript
// tools.js æ‰§è¡Œä»£ç å
observation.image_paths = ['/images/userId/timestamp-plot-0.png'];
observation.images_markdown = '![Plot 0](/images/.../plot-0.png)';

// LLM ç›´æ¥ä½¿ç”¨ observation ä¸­çš„è·¯å¾„
// ä¸ä¾èµ–å­—ç¬¦ä¸²åŒ¹é…å’Œæ›¿æ¢
```

**é—®é¢˜ä¿®å¤**: è·¯å¾„åŒé‡åµŒå¥— bug å®Œå…¨æ¶ˆå¤±

#### 7ï¸âƒ£ æ— é™é‡è¯•å¾ªç¯ä¿®å¤
**é—®é¢˜è¡¨ç°**:
```
iteration 1: code error
iteration 2: retry same code
iteration 3: retry same code
...
iteration 10: max iterations reached
```

**æ ¹æœ¬åŸå› **: observation æ ¼å¼ä¸ä¸€è‡´
- æˆåŠŸ: `{ success: true, stdout, stderr, has_plots, ... }`
- å¤±è´¥: `{ success: false, error }` â† ç¼ºå°‘å…³é”®å­—æ®µ

**LLM è§†è§’**: å¤±è´¥æ—¶æ²¡æœ‰è¶³å¤Ÿä¿¡æ¯åˆ¤æ–­åŸå› ï¼Œåªèƒ½é‡è¯•

**ä¿®å¤**: ç»Ÿä¸€æ ¼å¼ï¼Œå¤±è´¥æ—¶ä¹Ÿè¿”å›å®Œæ•´ç»“æ„
```javascript
return {
  success: false,
  error: error.message,
  stdout: '',
  stderr: error.message,  // æä¾› traceback
  has_plots: false,
  plot_count: 0,
  image_paths: [],
  images_markdown: '',
  plot_info: ''
};
```

**æ•ˆæœ**: LLM èƒ½å¤Ÿåˆ†æå¤±è´¥åŸå› å¹¶è°ƒæ•´ç­–ç•¥

#### 8ï¸âƒ£ å·¥å…·ç²¾ç®€
**å‘ç°**: download_file å®Œå…¨å†—ä½™
- execute_code å·²ç»è‡ªåŠ¨æŒä¹…åŒ–æ‰€æœ‰å›¾ç‰‡
- ä¸¤ä¸ªå·¥å…·åšç›¸åŒçš„äº‹ â†’ LLM å›°æƒ‘

**è¡ŒåŠ¨**:
- âœ… ç§»é™¤ download_file å·¥å…·å®šä¹‰
- âœ… æ›´æ–° System Prompt
- âœ… ä¿®å¤ E2B API è°ƒç”¨é”™è¯¯ï¼ˆ`.arrayBuffer()`, `.text()`ï¼‰

**ç»“æœ**: å·¥å…·èŒè´£æ›´æ¸…æ™°ï¼ŒLLM ä¸å†å›°æƒ‘

#### 9ï¸âƒ£ è¯Šæ–­æ—¥å¿—åŸºç¡€è®¾æ–½
**åŠ¨æœº**: å¤æ‚é—®é¢˜éœ€è¦è¯¦ç»†çš„æ‰§è¡Œè½¨è¿¹

**å®ç°**:
- codeExecutor: æ‰§è¡Œç»“æœçš„å®Œæ•´ JSON
- tools.js: observation å¯¹è±¡ï¼ˆæˆåŠŸå’Œå¤±è´¥ï¼‰
- index.js: å·¥å…·è°ƒç”¨å‚æ•°å’Œç»“æœ
- æµå¼/éæµå¼åˆ†åˆ«è®°å½•

**æ§åˆ¶**: `DEBUG_LOGGING=true` æˆ– `LOG_LEVEL=debug`

**ç”¨é€”**: è¯Šæ–­ä¸ºä½•æŸäº›å¤æ‚ä»»åŠ¡å¤±è´¥

#### ğŸ”Ÿ é”™è¯¯è‡ªæ„ˆèƒ½åŠ›éªŒè¯æ€»ç»“ ğŸ¯

**è®¾è®¡å“²å­¦éªŒè¯**ï¼š
```
æ—§æ–¹æ³•: ä¸ºæ¯ç§é”™è¯¯ç¡¬ç¼–ç è§£å†³æ–¹æ¡ˆ
       â†’ ä¸å¯æ‰©å±•ï¼Œæ— æ³•å¤„ç†æ–°é”™è¯¯

æ–°æ–¹æ³•: æ•™ä¼š LLM å¦‚ä½•è°ƒè¯•
       â†’ âœ… éªŒè¯æˆåŠŸï¼å¯å¤„ç†æœªè§è¿‡çš„é”™è¯¯
```

**çœŸå®æ¡ˆä¾‹åˆ†æ**ï¼š
- **é”™è¯¯ç±»å‹**: pandas DataFrame ç±»å‹è½¬æ¢é”™è¯¯
- **LLM æ¨ç†è¿‡ç¨‹**:
  1. è¯»å– traceback: "could not convert string to float"
  2. è¯†åˆ«é—®é¢˜: æ•°æ®ä¸­åŒ…å«å­—ç¬¦ä¸²ç±»å‹åˆ—ï¼ˆName åˆ—ï¼‰
  3. åº”ç”¨é€šç”¨ç­–ç•¥: ä½¿ç”¨ `df.dtypes` æ£€æŸ¥ï¼Œç”¨ `select_dtypes()` ç­›é€‰
  4. å®æ–½ä¿®å¤: åªå¯¹æ•°å€¼åˆ—è®¡ç®—ç›¸å…³æ€§
  5. éªŒè¯ç»“æœ: æˆåŠŸç”Ÿæˆå¯è§†åŒ–

**æ€§èƒ½æŒ‡æ ‡**ï¼š
- è¿­ä»£æ¬¡æ•°: 14/20 (70%ï¼Œåœ¨åˆç†èŒƒå›´)
- é”™è¯¯æ¢å¤: 4æ¬¡å¤±è´¥ â†’ æˆåŠŸ
- è‡ªä¸»ç¨‹åº¦: 100% (æ— éœ€ç³»ç»Ÿå¹²é¢„)
- è¾“å‡ºè´¨é‡: å®Œæ•´çš„åˆ†æ + çƒ­åŠ›å›¾

**æ¶æ„ä¼˜åŠ¿**ï¼š
```
Tier 1 (å…³é”®é”™è¯¯): FileNotFound, ImportError, matplotlib
       â†’ æä¾›ç‰¹å®šæŒ‡å¯¼ï¼Œå¿«é€Ÿè§£å†³ç¯å¢ƒé—®é¢˜

Tier 2 (é€šç”¨è°ƒè¯•): æ‰€æœ‰å…¶ä»–é”™è¯¯
       â†’ æä¾›è°ƒè¯•å·¥å…·å’Œæ€è·¯
       â†’ âœ… æœ¬æ¬¡éªŒè¯ï¼šæˆåŠŸå¤„ç† ValueError

Tier 3 (LLM è‡ªä¸»): åˆ†æã€æ¨ç†ã€å®æ–½
       â†’ âœ… æœ¬æ¬¡éªŒè¯ï¼šå®Œæ•´çš„è°ƒè¯•æµç¨‹
```

**ç»“è®º**ï¼š
- âœ… é€šç”¨é”™è¯¯å¤„ç†ç­–ç•¥å®Œå…¨æ»¡è¶³éœ€æ±‚
- âœ… LLM å…·å¤‡ç‹¬ç«‹è§£å†³å¤æ‚æ•°æ®åˆ†æé”™è¯¯çš„èƒ½åŠ›
- âœ… ç³»ç»Ÿå¯æ‰©å±•åˆ°æœªæ¥çš„æ–°é”™è¯¯ç±»å‹
- âœ… é¿å…äº†ç»´æŠ¤å¤§é‡ç‰¹å®šé”™è¯¯å¤„ç†ä»£ç çš„è´Ÿæ‹…

---

---

## 11. 2026-01-14 å…³é”® Bug ä¿®å¤ â­

### 11.1 é”™è¯¯æ£€æµ‹é€»è¾‘ä¸¥é‡ Bug ä¿®å¤

**é—®é¢˜**: LLM é‡å¤æ‰§è¡Œå¤±è´¥ä»£ç ï¼Œæ— æ³•è‡ªåŠ¨ä¿®å¤é”™è¯¯  
**æ ¹å› **: `initialize.js` ä½¿ç”¨ `!result.error` åˆ¤æ–­é”™è¯¯ï¼Œå½“ `result.error` æ˜¯å¯¹è±¡æ—¶è¯¯åˆ¤ä¸ºæˆåŠŸ  
**ä¿®å¤**: 
- ä½¿ç”¨æ˜ç¡®çš„ `hasError` å¸ƒå°”å˜é‡
- æ·»åŠ  `errorName` å’Œ `traceback` å­—æ®µä¼ é€’
- å®Œæ•´çš„é”™è¯¯ä¿¡æ¯é“¾ï¼šinitialize.js â†’ codeExecutor.js â†’ tools.js â†’ LLM

**å½±å“æ–‡ä»¶**:
- `api/server/services/Endpoints/e2bAssistants/initialize.js`
- `api/server/services/Sandbox/codeExecutor.js`
- `api/server/services/Agents/e2bAgent/tools.js`

**éªŒè¯ç»“æœ**: âœ… é”™è¯¯è‡ªåŠ¨ä¿®å¤æˆåŠŸï¼ˆValueError â†’ select_dtypes ä¿®å¤ï¼‰

### 11.2 å›¾è¡¨æ˜¾ç¤ºé—®é¢˜ä¿®å¤

**é—®é¢˜**: å›¾è¡¨ç”ŸæˆæˆåŠŸä½†å‰ç«¯ä¸æ˜¾ç¤º  
**æ ¹å› **: LLM æ²¡æœ‰è¾“å‡º markdown è¯­æ³•æ˜¾ç¤ºå›¾ç‰‡  
**ä¿®å¤**: åœ¨ System Prompt ä¸­æ˜ç¡®è¦æ±‚ "YOU MUST output the image markdown"  

**å½±å“æ–‡ä»¶**:
- `api/server/services/Agents/e2bAgent/prompts.js`

**çŠ¶æ€**: â³ ç­‰å¾…ç”¨æˆ·æµ‹è¯•éªŒè¯

### 11.3 é€šç”¨é”™è¯¯å¤„ç†ç­–ç•¥

**ä¼˜åŒ–**: ç§»é™¤é’ˆå¯¹ç‰¹å®šé”™è¯¯çš„ç¡¬ç¼–ç æç¤ºï¼Œæ”¹ä¸ºé€šç”¨è°ƒè¯•ç­–ç•¥  
**ä¼˜åŠ¿**: 
- å¯å¤„ç†æœªè§è¿‡çš„é”™è¯¯
- LLM å­¦ä¼šè°ƒè¯•æ–¹æ³•
- ä»£ç æ›´ç®€æ´

### 11.4 TOOL_CALL äº‹ä»¶ä¸ ExecuteCode ç»„ä»¶é›†æˆ â­

**åŠŸèƒ½**: å®ç° Azure Assistant é£æ ¼çš„ä»£ç å’Œè¾“å‡ºæ˜¾ç¤º

**æ ¸å¿ƒæ¶æ„** - Content æ•°ç»„ç³»ç»Ÿï¼š
```javascript
// äº¤é”™çš„ TEXT å’Œ TOOL_CALL parts
message.content = [
  { type: 'text', text: { value: 'åˆ†æå¼€å§‹...' } },      // index 0
  { type: 'tool_call', tool_call: {                      // index 1
      id: 'call_123',
      name: 'execute_code',
      args: '{"lang":"python","code":"df.head()"}',
      progress: 1.0,
      output: '...'  // æ‰§è¡Œç»“æœ
    }
  },
  { type: 'text', text: { value: 'ä»ç»“æœçœ‹å‡º...' } },    // index 2
]
```

**å®ç°ç»„ä»¶**:
1. **controller.js**: åˆå§‹åŒ– contentParts æ•°ç»„ï¼Œç®¡ç† TEXT part åˆ‡æ¢
2. **index.js**: å‘é€ TOOL_CALL äº‹ä»¶ï¼ˆå¼€å§‹/å®Œæˆï¼‰ï¼Œè°ƒç”¨ startNewTextPart()
3. **å‰ç«¯ ExecuteCode**: è‡ªåŠ¨è§£æ args å­—æ®µï¼Œæ¸²æŸ“ä»£ç å’Œè¾“å‡º

**æ˜¾ç¤ºæ•ˆæœ**: 
- âœ… ä»£ç å—å’Œè¾“å‡ºæ¡†ç´§å¯†æ˜¾ç¤º
- âœ… å¤šæ¬¡å·¥å…·è°ƒç”¨æ­£ç¡®æ’åº
- âœ… æ–‡æœ¬è¯´æ˜å’Œä»£ç æ‰§è¡Œäº¤é”™æ˜¾ç¤º
- âœ… å®Œå…¨ç¬¦åˆ Azure Assistant é£æ ¼

**å½±å“æ–‡ä»¶**:
- `api/server/routes/e2bAssistants/controller.js` - Content æ•°ç»„ç®¡ç†
- `api/server/services/Agents/e2bAgent/index.js` - TOOL_CALL äº‹ä»¶å‘é€

---

**åˆ›å»ºæ—¥æœŸ**: 2025-12-23  
**æœ€åæ›´æ–°**: 2026-01-14  
**å½“å‰çŠ¶æ€**: âœ… æ ¸å¿ƒåŠŸèƒ½å®Œæˆï¼å…³é”® bug ä¿®å¤å®Œæˆï¼ˆé”™è¯¯æ£€æµ‹ã€å›¾è¡¨æ˜¾ç¤ºã€é€šç”¨é”™è¯¯å¤„ç†ï¼‰ã€‚åŠ©æ‰‹é…ç½®ã€å†å²å¯¹è¯ã€å›¾åƒæ˜¾ç¤ºã€æ²™ç®±å¤ç”¨ã€é”™è¯¯è‡ªæ„ˆå‡å·²æ­£å¸¸å·¥ä½œã€‚
**å½“å‰åˆ†æ”¯**: `feature/e2b-integration`
