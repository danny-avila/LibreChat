name: Build & Deploy LibreChat to EC2 via OIDC + SSM

# ----------------------------------------------------------
# Triggers
# ----------------------------------------------------------
# - Build automatically on pushes to main
# - Can be manually run from GitHub UI
# ----------------------------------------------------------
on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  AWS_REGION: us-east-1

# ----------------------------------------------------------
# Required GitHub permissions
# ----------------------------------------------------------
# id-token: write   ‚Üí required for AWS OIDC authentication
# contents: read    ‚Üí needed for repo checkout
# packages: write   ‚Üí needed to PUSH Docker images to GHCR
# ----------------------------------------------------------
permissions:
  id-token: write
  contents: read
  packages: write

jobs:

# ==========================================================
#  JOB 1: Build and Push Docker Images to GHCR
# ==========================================================
  build-and-push:
    runs-on: ubuntu-latest

    steps:

      # Checkout repository source code
      - name: Checkout source
        uses: actions/checkout@v4

      # Ensure GHCR namespace is lowercase (required by GHCR)
      - name: Normalize repository owner to lowercase
        run: echo "REPO_OWNER_LC=${GITHUB_REPOSITORY_OWNER,,}" >> "$GITHUB_ENV"

      # Construct the GHCR image name
      - name: Set API image name
        run: echo "IMAGE_API=ghcr.io/${REPO_OWNER_LC}/librechat-api" >> "$GITHUB_ENV"

      # Enable multi-architecture builds
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      # Enable Docker Buildx (advanced builder)
      - name: Set up Buildx
        uses: docker/setup-buildx-action@v3

      # Login to GitHub Container Registry for pushing images
      - name: Log into GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # Build and push Docker image to GHCR
      # - Uses multi-stage Dockerfile
      # - Pushes :latest and :commit-sha tags
      - name: Build & Push LibreChat API Container
        uses: docker/build-push-action@v6
        with:
          context: .
          file: Dockerfile.multi
          target: api-build
          push: true
          tags: |
            ${{ env.IMAGE_API }}:latest
            ${{ env.IMAGE_API }}:${{ github.sha }}

# ==========================================================
#  JOB 2: Deploy to EC2 via AWS SSM
# ==========================================================
  deploy:
    runs-on: ubuntu-latest
    needs: build-and-push

    permissions:
      id-token: write
      contents: read

      # REQUIRED for the deploy job because EC2 uses the GitHub token
      # to pull images from GHCR.
      packages: read

    steps:

      # ------------------------------------------------------
      # Authenticate to AWS using OIDC (no static secrets)
      # ------------------------------------------------------
      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::395567831871:role/github-actions
          aws-region: ${{ env.AWS_REGION }}

      # Resolve EC2 instance ID (hard-coded, but can be a variable)
      - name: Resolve EC2 Instance ID
        id: ec2
        run: |
          INSTANCE_ID="i-060babef69922d8b4"
          echo "instance_id=$INSTANCE_ID" >> "$GITHUB_OUTPUT"

      # ------------------------------------------------------
      # Ensure EC2 instance is SSM-Managed before deployment
      # ------------------------------------------------------
      - name: Ensure EC2 Instance is SSM Managed
        run: |
          IID="${{ steps.ec2.outputs.instance_id }}"

          # Query if instance is registered with SSM
          MATCH=$(aws ssm describe-instance-information \
            --query "InstanceInformationList[?InstanceId=='$IID'].InstanceId" \
            --output text)

          if [ "$MATCH" != "$IID" ]; then
            echo "‚ùå Instance $IID is NOT SSM-managed. Fix IAM role or SSM agent."
            exit 1
          fi

          echo "‚úÖ Instance $IID is SSM-managed."

      # ------------------------------------------------------
      # Execute deployment commands inside EC2 via AWS SSM
      # ------------------------------------------------------
      - name: Execute Remote Deployment on EC2 via SSM
        id: send
        run: |
          IID="${{ steps.ec2.outputs.instance_id }}"
          OWNER="${{ github.repository_owner }}"
          TOKEN="${{ secrets.GITHUB_TOKEN }}"

          CMD_ID=$(aws ssm send-command \
            --instance-ids "$IID" \
            --document-name "AWS-RunShellScript" \
            --comment "LibreChat CI Deployment" \
            --parameters "commands=[
              \"set -e\",
              \"cd /opt/LibreChat\",

              \"echo 'üîê Logging into GHCR...'\",
              \"echo '$TOKEN' | docker login ghcr.io -u '$OWNER' --password-stdin || { echo '‚ùå GHCR login failed'; exit 1; }\",

              \"echo 'üì¶ Pulling updated Docker images...'\",
              \"docker compose -f deploy-compose.yml pull || { echo '‚ùå Docker pull failed'; docker logout ghcr.io; exit 1; }\",

              \"echo 'üöÄ Recreating containers...'\",
              \"docker compose -f deploy-compose.yml up -d --force-recreate || { echo '‚ùå Docker compose up failed'; docker logout ghcr.io; exit 1; }\",

              \"docker logout ghcr.io\",
              \"docker image prune -af\"
            ]" \
            --query "Command.CommandId" \
            --output text)

          echo "command_id=$CMD_ID" >> "$GITHUB_OUTPUT"
          echo "üü¢ Triggered SSM command ID: $CMD_ID"

      # ------------------------------------------------------
      # Install jq (needed for parsing JSON from SSM)
      # ------------------------------------------------------
      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      # ------------------------------------------------------
      # Wait for SSM to finish and retrieve logs
      # ------------------------------------------------------
      - name: Wait for EC2 Deployment Completion and Fetch Logs
        timeout-minutes: 5   # Stop stuck deployments
        run: |
          IID="${{ steps.ec2.outputs.instance_id }}"
          CID="${{ steps.send.outputs.command_id }}"

          echo "‚è≥ Waiting for SSM command to complete (max 5 minutes)..."

          # This waits until the EC2 command completes OR fails
          aws ssm wait command-executed \
            --command-id "$CID" \
            --instance-id "$IID" \
            || echo "‚ö†Ô∏è Warning: Command may have failed or timed out"

          echo "üìú Fetching remote EC2 logs..."
          RESULT=$(aws ssm get-command-invocation \
            --command-id "$CID" \
            --instance-id "$IID" \
            --query '{Status:Status, StdOut:StandardOutputContent, StdErr:StandardErrorContent}' \
            --output json)

          echo "$RESULT"

          STATUS=$(echo "$RESULT" | jq -r '.Status')

          if [ "$STATUS" != "Success" ]; then
            echo "‚ùå Deployment failed with status: $STATUS"
            exit 1
          fi

          echo "‚úÖ Deployment completed successfully!"
