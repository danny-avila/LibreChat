name: Build & Deploy LibreChat to EC2 via OIDC

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  AWS_REGION: us-east-1

permissions:
  id-token: write        # Needed for OIDC
  contents: read
  packages: write        # For GHCR push

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout source
        uses: actions/checkout@v4
      
      - name: Set lowercase repository owner
        run: |
          echo "REPO_OWNER_LC=${OWNER,,}" >> ${GITHUB_ENV}
        env:
          OWNER: '${{ github.repository_owner }}'
      
      - name: Set image name
        run: |
          echo "IMAGE_API=ghcr.io/${REPO_OWNER_LC}/librechat-api" >> ${GITHUB_ENV}
      
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
      
      - name: Set up Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Build & Push LibreChat API
        uses: docker/build-push-action@v6
        with:
          context: .
          file: Dockerfile.multi
          push: true
          tags: |
            ${{ env.IMAGE_API }}:latest
            ${{ env.IMAGE_API }}:${{ github.sha }}

  deploy:
    runs-on: ubuntu-latest
    needs: build-and-push
    permissions:
      id-token: write
      contents: read
    steps:
      - name: Set lowercase repository owner
        run: |
          echo "REPO_OWNER_LC=${OWNER,,}" >> ${GITHUB_ENV}
        env:
          OWNER: '${{ github.repository_owner }}'
      
      - name: Set image name
        run: |
          echo "IMAGE_API=ghcr.io/${REPO_OWNER_LC}/librechat-api" >> ${GITHUB_ENV}
      
      - name: Configure AWS Credentials using OIDC
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::395567831871:role/github-actions
          aws-region: ${{ env.AWS_REGION }}
      
      - name: Verify AWS identity
        run: aws sts get-caller-identity
      
      - name: Retrieve EC2 instance IP
        id: ec2
        run: |
          INSTANCE_ID=$(aws ec2 describe-instances \
            --filters "Name=tag:Name,Values=LibreChat-EC2" \
            --query "Reservations[0].Instances[0].InstanceId" \
            --output text)
          echo "instance_id=$INSTANCE_ID" >> $GITHUB_OUTPUT
          INSTANCE_IP=$(aws ec2 describe-instances \
            --instance-ids $INSTANCE_ID \
            --query "Reservations[0].Instances[0].PublicDnsName" \
            --output text)
          echo "instance_ip=$INSTANCE_IP" >> $GITHUB_OUTPUT
      
      - name: Send SSH public key using EC2 Instance Connect
        run: |
          echo "${{ secrets.SSH_PUBLIC_KEY }}" > /tmp/tmpkey.pub
          aws ec2-instance-connect send-ssh-public-key \
            --instance-id ${{ steps.ec2.outputs.instance_id }} \
            --availability-zone $(aws ec2 describe-instances --instance-ids ${{ steps.ec2.outputs.instance_id }} --query "Reservations[0].Instances[0].Placement.AvailabilityZone" --output text) \
            --instance-os-user ubuntu \
            --ssh-public-key file:///tmp/tmpkey.pub
      
      - name: Deploy LibreChat on EC2
        run: |
          ssh -o StrictHostKeyChecking=no ubuntu@${{ steps.ec2.outputs.instance_ip }} <<'EOF'
          cd /opt/LibreChat
          docker compose -f deploy-compose.yml pull
          docker compose -f deploy-compose.yml up -d --force-recreate
          docker image prune -af
          EOF
