#!/bin/bash

# ะกะบัะธะฟั ะดะปั ัะตััะธัะพะฒะฐะฝะธั ัะฑะพัะบะธ ะฟะตัะตะด ัะฐะทะฒะตัััะฒะฐะฝะธะตะผ ะฝะฐ Zeabur
# ะะพัะฟัะพะธะทะฒะพะดะธั ััะปะพะฒะธั ัะฑะพัะบะธ ะฝะฐ Zeabur ะปะพะบะฐะปัะฝะพ

echo "๐ง ะขะตััะธัะพะฒะฐะฝะธะต ัะฑะพัะบะธ ะดะปั Zeabur..."

# ะัะธััะบะฐ ะบััะฐ ะธ node_modules
echo "๐งน ะัะธััะบะฐ ะบััะฐ..."
rm -rf node_modules client/node_modules api/node_modules packages/*/node_modules
rm -rf client/dist client/.vite
npm cache clean --force

# ะฃััะฐะฝะพะฒะบะฐ ะทะฐะฒะธัะธะผะพััะตะน
echo "๐ฆ ะฃััะฐะฝะพะฒะบะฐ ะทะฐะฒะธัะธะผะพััะตะน..."
npm ci

# ะัะธะผะตะฝะตะฝะธะต ะฟะฐััะตะน
echo "๐ฉน ะัะธะผะตะฝะตะฝะธะต ะฟะฐััะตะน ะดะปั react-virtualized..."
npm run postinstall

# ะฃะฒะตะปะธัะธะฒะฐะตะผ ะปะธะผะธัั ะฟะฐะผััะธ ะดะปั Node.js
export NODE_OPTIONS="--max-old-space-size=4096"
export NODE_ENV=production

# ะกะฑะพัะบะฐ ั ะฟะพะดัะพะฑะฝัะผ ะปะพะณะธัะพะฒะฐะฝะธะตะผ
echo "๐๏ธ ะกะฑะพัะบะฐ frontend..."
npm run frontend 2>&1 | tee build.log

# ะัะพะฒะตัะบะฐ ัะตะทัะปััะฐัะฐ
if [ $? -eq 0 ]; then
    echo "โ ะกะฑะพัะบะฐ ััะฟะตัะฝะพ ะทะฐะฒะตััะตะฝะฐ!"
    echo "๐ ะัะพะฒะตัััะต ะดะธัะตะบัะพัะธั client/dist"
    ls -la client/dist/
else
    echo "โ ะัะธะฑะบะฐ ัะฑะพัะบะธ!"
    echo "๐ ะัะพะฒะตัััะต ัะฐะนะป build.log ะดะปั ะดะตัะฐะปะตะน"
    exit 1
fi

echo "๐ ะขะตัั ะทะฐะฒะตััะตะฝ ััะฟะตัะฝะพ!"
