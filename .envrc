#!/usr/bin/env bash

set -euo pipefail

region='eu-central-1'
dotenv_if_exists .env.config

export \
  AWS_REGION=$region \
  AWS_DEFAULT_REGION=$region

if [ -z "${AWS_PROFILE}" ]; then
  echo "Error: AWS_PROFILE is not set. Please set it first."
  exit 1
fi

# Get credentials and parse with jq
declare creds
if ! creds=$(aws configure export-credentials --profile "${AWS_PROFILE}"); then
  echo "Error: Failed to get AWS credentials. Please check if you're logged in with 'aws sso login'"
  exit 1
fi

export BEDROCK_AWS_DEFAULT_REGION="$AWS_REGION"

declare access_key_id
declare secret_access_key
declare session_token

access_key_id=$(echo "$creds" | jq -r '.AccessKeyId')
secret_access_key=$(echo "$creds" | jq -r '.SecretAccessKey')
session_token=$(echo "$creds" | jq -r '.SessionToken')

export BEDROCK_AWS_ACCESS_KEY_ID="$access_key_id"
export BEDROCK_AWS_SECRET_ACCESS_KEY="$secret_access_key"
export BEDROCK_AWS_SESSION_TOKEN="$session_token"
